@model DetailsViewModel;

<head>
    <title>@Model.TourName</title>
    <link rel="stylesheet" href="~/css/gallerypictures.css" style="stylesheet" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/css/lightbox.min.css">
    <link rel="stylesheet" href="~/css/votestartstyle.css" style="stylesheet" />
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined:opsz,wght,FILL,GRAD@20..48,100..700,0..1,-50..200" />
    <style>
        .text-truncate {
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
            display: block;
            width: 100%;
            cursor: help;
        }
    </style>

</head>


<div class="text-center mb-5">
    <h2>@Model.TourName</h2>
</div>


@if (Model.AllTourApplicationImages != null && Model.AllTourApplicationImages.Count > 0)
{

    <div class="container overflow-hidden">
        <div class="gallery">
            @for (int i = 0; i < Model.AllTourApplicationImages.Count; i++)
            {
                @if (i == 0)
                {
                    <figure class="gallery__item gallery__item--1">
                        <a href="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                           data-lightbox="gallery"
                           data-title="@Model.TourName">
                            <img src="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                                 alt="" class="img-fluid">
                        </a>
                    </figure>
                   
                }
                else if (i == 1)
                {
                    <figure class="gallery__item gallery__item--2">
                        <a href="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                           data-lightbox="gallery"
                           data-title="@Model.TourName">
                            <img src="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                                 alt="" class="img-fluid">
                        </a>
                    </figure>
                }
                else if (i == 2)
                {
                    <figure class="gallery__item gallery__item--3">

                        <a href="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                           data-lightbox="gallery"
                           data-title="@Model.TourName">

                            <img src="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                                 alt="" class="img-fluid">
                        </a>
                    </figure>
                }
                else if (i == 3)
                {
                    <figure class="gallery__item gallery__item--4">
                        <a href="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                           data-lightbox="gallery" style=""
                           data-title="@Model.TourName">
                            <img src="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                                 alt="" class="img-fluid">
                        </a>
                    </figure>

                }
                else if (i >= 4)
                {
                    <a class="d-none" href="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                       data-lightbox="gallery"
                       data-title="@Model.TourName">
                        <img src="@("data:image/jpeg;base64," + Convert.ToBase64String(Model.AllTourApplicationImages[i].FileData))"
                             alt="" class="img-fluid">
                    </a>


                }

            }
        </div>


    </div>

}
else
{
    <div class="alert alert-warning">No images available for this tour.</div>
}
<div class="container-info overflow-hidden">
 
    <div class="row mb-5">
        <div class="col-md-3">
            <strong>
                <span class="material-symbols-outlined">payments</span>Price Per Person
            </strong> <span>@Model.PricePerPerson</span>
        </div>
        <div class="col-md-3">
            <strong>
                <span class="material-symbols-outlined">av_timer</span>Duration - 
            </strong>@Model.Duaration
        </div>
        <div class="col-md-3">
            <span class="material-symbols-outlined">public</span>
            <strong>Location:</strong> <span>@Model.LocationCity, @Model.LocationCountry</span>
        </div>
        <div class="col-md-3">
            <span class="material-symbols-outlined">category</span>
            <strong>Category:</strong> <span>@Model.Category</span>
        </div>
    </div>

   
    <div class="row mb-5">
        <div class="col-md-6">
            <strong>Meeting Point:</strong> <span class="text-truncate" title="@Model.MeetingPoint">@Model.MeetingPoint</span>
        </div>
        <div class="col-md-6">
        <strong>See on Google Map:</strong> <a href="@Model.MeetingPointMapUrl" style="cursor:pointer">Map Link</a>
    </div>
    </div>

    
    
    <div class="row mb-5" <span class="material-symbols-outlined">info</span>
        
        <div class="col-xxl-1">
            <strong>Know Before You Go:</strong> <span class="text-truncate" title="@Model.KnowBeforeYouGo">@Model.KnowBeforeYouGo</span>
        </div>        
    </div>

    <div class="row mb-5">
        <div class="col-xxl-1">
            <strong>Not Suitable For:</strong> <span>@Model.NotSuitableFor</span>
        </div>
    </div>

    <div class="row mb-5">
        <div class="col-lg-5">
            <strong>What to Bring:</strong> <span class="text-truncate" title="@Model.WhatToBring">@Model.WhatToBring</span>
        </div>
        <div class="col-lg-5">
            <strong>Includes:</strong> <span>@Model.Includes</span>
        </div>
        
    </div>
    <div class="row mb-5">
        <div class="col-md-5">
            <strong>Full Description:</strong> <span class="text-truncate" title="@Model.FullDescription">@Model.FullDescription</span>
        </div>
    </div>
    
   
</div>

<div class="row mb-auto">
    @*   @if (isUserGuide)*@
    <div>
        <form asp-controller="TouristTour" asp-action="DeleteTour" asp-route-tourId="@Model.Id" method="post" class="d-inline ml-2">
            <button type="submit" class="btn btn-danger">DeleteTour</button>
        </form>
        <a asp-controller="Booking" asp-action="BookingTours" asp-route-tourId="@Model.Id" class="btn btn-success d-inline ml-3">Tour bookings</a>
    </div>

</div>

<a asp-controller="Booking" asp-action="Create" asp-route-tourId="@Model.Id"  class="btn btn-success d-inline ml-3 ">Create book</a>

@*TODO hide div for regulate users*@
<div class="row mt-5">
    <div class="col-lg-12" onclick="">
        <h4>Add a new image to your tour:</h4>
        <form method="post" enctype="multipart/form-data" asp-action="AddImage" asp-controller="TouristTour">
            <input type="hidden" name="tourId" value="@Model.Id" />
            <div class="form-group">
                <input type="file" name="imageFile" required class="form-control mb-3" />
                <button type="submit" class="btn btn-primary btn-block">Upload Image</button>
            </div>
        </form>
    </div>
</div>



<div class="star-rating">
    <ul class="ratings">
        <li class="star" onclick="sendVote('@Model.Id',1)"></li>
        <li class="star" onclick="sendVote('@Model.Id',2)"></li>
        <li class="star" onclick="sendVote('@Model.Id',3)"></li>
        <li class="star" onclick="sendVote('@Model.Id',4)"></li>
        <li class="star" onclick="sendVote('@Model.Id',5)"></li>
    </ul>
</div>



<div class="row" style="padding-top:0.1em">
    <div class="col">
        <p id="ratingDisplay">@Model.TourRatign.ToString("f2")</p>
    </div>
</div>



<section style="background-color:#fff;">
    <div class="container my-5 py-5">
        <div class="row d-flex justify-content-center right-align-comments">
            <div class="col-md-12 col-lg-10 col-xl-8 col-md-offset">
                <div class="card">
                    <div class="comments-container">
                        @for (int i = 0; i < Model.Comments.Count; i++)
                        {
                            <div class="card-body" style="display: @(i < 3 ? "block" : "none")">
                                <div class="d-flex flex-start align-items-center">
                                    <img class="rounded-circle shadow-1-strong me-3"
                                         src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp" alt="avatar" width="60"
                                         height="60" />
                                    <div>
                                        <h6 class="fw-bold text-primary mb-1">
                                            @Model.Comments[i].AppUserName
                                        </h6>
                                        <p class="text-muted small mb-0">
                                            Shared publicly - Jan 2020
                                        </p>
                                    </div>
                                </div>
                                <p class="mt-3 mb-4 pb-2">
                                    @Model.Comments[i].Content;
                                </p>
                            </div>
                        }
                        @if (Model.Comments.Count > 5)
                        {
                            <button id="readMoreBtn" class="btn btn-primary">Прочети повече коментари</button>
                        }
                    </div>

                    <button id="showFormBtn" class="btn btn-primary">Покажи формуляра</button>
                    <form id="commentForm" style="display:none;">
                        <div class="card-footer py-3 border-2 justify-content-start" style="background-color: #f8f9fa;">
                            <div class="d-flex flex-start w-100">
                                <img class="rounded-circle shadow-1-strong me-3"
                                     src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp" alt="avatar" width="40"
                                     height="40" />
                                <div data-mdb-input-init class="form-outline w-100">
                                    <textarea class="form-control" id="Content" name="Content" rows="5"
                                              style="background: #fff; flex-shrink:unset"></textarea>
                                </div>
                            </div>
                            <input type="hidden" id="TourId" name="TourId" value="@Model.Id">
                            <div class="float-end mt-2 pt-1">
                                <button type="button" for="Content"
                                        id="postCommentBtn"
                                        data-mdb-button-init data-mdb-ripple-init class="btn btn-primary btn-sm">
                                    Post comment
                                </button>
                            </div>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</section>



<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/5.0.0-beta3/js/bootstrap.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/lightbox2/2.11.3/js/lightbox.min.js"></script>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


<script>
    $(document).ready(function () {
        $('#showFormBtn').click(function () {
            var form = $('#commentForm');
            if (form.css('display') === 'none') {
                form.show();
            } else {
                form.hide();
            }
        });

        $('#readMoreBtn').click(function () {
            var hiddenComments = $('.card-body:hidden');
            hiddenComments.slice(0, 3).slideDown();
            if (hiddenComments.length <= 3) {
                $(this).hide();
            }
        });

        $('#postCommentBtn').click(function () {
            var content = $('#Content').val().trim();
            var tourId = $('#TourId').val();

            if (content === "") {
                alert('Please enter a message.');
                return false;
            }

            $.ajax({
                url: '/Comment/CreateComment',
                type: 'POST',
                contentType: 'application/json',
                data: JSON.stringify({ Content: content, TourId: tourId }),
                success: function (response) {
                    alert('Comment posted successfully');
                    $('#Content').val(''); 
                    var newCommentHtml = '<div class="card-body">' +
                        '<div class="d-flex flex-start align-items-center">' +
                        '<img class="rounded-circle shadow-1-strong me-3" src="https://mdbcdn.b-cdn.net/img/Photos/Avatars/img%20(19).webp" alt="avatar" width="60" height="60" />' +
                        '<div>' +
                        '<h6 class="fw-bold text-primary mb-1">' + response.userName + '</h6>' +
                        '<p class="text-muted small mb-0">' +
                        'Shared publicly - just now' +
                        '</p>' +
                        '</div>' +
                        '</div>' +
                        '<p class="mt-3 mb-4 pb-2">' +
                        content +
                        '</p>' +
                        '</div>';
                    $('.comments-container').prepend(newCommentHtml);

                },
                error: function () {
                    alert('Error posting comment');
                }
            });
        });
    });
</script>


<script>

    function sendVote(tourId, starValue) {
        var json = { tourId: tourId, starValue: starValue };


        $.ajax({
            url: "/api/vote",
            type: "POST",
            data: JSON.stringify(json),
            contentType: "application/json;charset=utf-8",
            dataType: "json",
            success: function (response) {
                console.log(response);
                var newRatingValue = response.ratingResultAfretVote;
                $('#ratingDisplay').text(newRatingValue.toFixed(2));
            }
        });

    }

</script>




<script>
    lightbox.option({
        'resizeDuration': 200,
        'wrapAround': true,
        'alwaysShowNavOnTouchDevices': true
    });

</script>

<script>

    function deleteImage(fileName, tourId) {
        if (confirm('Are you sure you want to delete this image?')) {
            fetch(`/Tour/DelatePicture?fileName=${fileName}&tourId=${tourId}`, {
                method: 'POST'
            }).then(response => response.text()).then(data => {
                if (data === 'success') {
                    alert('Image deleted successfully');
                   
                }
                else {
                    alert('Failed to delete image');
                }
            });
        }
    }

</script>


